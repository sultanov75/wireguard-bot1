# Решение проблемы блокировки бота пользователями

## Проблема
Когда пользователь блокирует бота в Telegram, возникает ошибка `BotBlocked('Forbidden: bot was blocked by the user')`. При этом конфигурации пользователя остаются в WireGuard и базе данных, что может привести к утечке ресурсов.

## Решение
Реализована система автоматической обработки блокировки бота с полным удалением пользователя и его конфигураций.

### Новые функции

#### 1. Обработка ошибок блокировки (`utils/bot_error_handler.py`)
- `handle_bot_blocked_error()` - автоматическая обработка ошибок BotBlocked
- `safe_send_message()` - безопасная отправка сообщений с обработкой блокировки
- `check_user_access()` - проверка доступа пользователя (не заблокирован, подписка активна)

#### 2. Управление блокировкой в базе данных (`database/update.py`)
- `ban_user(user_id)` - заблокировать пользователя навсегда
- `unban_user(user_id)` - разблокировать пользователя

#### 3. Проверка статуса блокировки (`database/selector.py`)
- `is_user_banned(user_id)` - проверить, заблокирован ли пользователь

#### 4. Управление конфигурациями WireGuard (`utils/vpn_cfg_work.py`)
- `permanently_remove_peer(user_id)` - полное удаление пира из конфига WireGuard
- `remove_user_configs_from_db(user_id)` - удаление конфигураций из базы данных
- `ban_user_completely(user_id)` - полная блокировка: удаление из WireGuard + БД + пометка как заблокированный

### Новые админские команды

#### `/ban <user_id>`
Полностью блокирует пользователя:
- Удаляет все конфигурации из WireGuard
- Удаляет конфигурации из базы данных
- Помечает пользователя как заблокированного
- Уведомляет всех администраторов

#### `/unban <user_id>`
Разблокирует пользователя:
- Снимает флаг блокировки
- Пользователь может снова использовать бота
- Уведомляет всех администраторов

#### `/status <user_id>`
Показывает полную информацию о пользователе:
- Статус блокировки
- Дата окончания подписки
- Список конфигураций
- Статус подписки (активна/истекла)

### Автоматическая обработка

#### Watchdog система
Обновлена система уведомлений (`utils/watchdog.py`):
- Использует `safe_send_message()` для отправки уведомлений
- Автоматически блокирует пользователей при ошибке BotBlocked
- Логирует неудачные попытки отправки сообщений

#### Проверка при старте
В команде `/start` добавлена проверка:
- Заблокированные пользователи получают сообщение о блокировке
- Доступ к функциям бота ограничен

## Как это работает

### Сценарий 1: Пользователь заблокировал бота
1. Watchdog пытается отправить уведомление пользователю
2. Получает ошибку `BotBlocked`
3. Автоматически вызывается `handle_bot_blocked_error()`
4. Пользователь полностью блокируется через `ban_user_completely()`
5. Все конфигурации удаляются из WireGuard и базы данных
6. Пользователь помечается как заблокированный

### Сценарий 2: Админ блокирует пользователя вручную
1. Админ использует команду `/ban <user_id>`
2. Вызывается `ban_user_completely()`
3. Удаляются все конфигурации и блокируется доступ
4. Все админы получают уведомление

### Сценарий 3: Разблокировка пользователя
1. Админ использует команду `/unban <user_id>`
2. Снимается флаг блокировки
3. Пользователь может снова использовать бота
4. Все админы получают уведомление

## Логирование

Все действия логируются с соответствующими уровнями:
- `logger.warning()` - для блокировок и важных событий
- `logger.info()` - для обычных операций
- `logger.error()` - для ошибок

## Безопасность

- Заблокированные пользователи не могут использовать бота
- Все конфигурации полностью удаляются при блокировке
- Админские команды защищены декоратором `@is_admin`
- Уведомления отправляются всем администраторам

## Примеры использования

```bash
# Заблокировать пользователя
/ban 123456789

# Разблокировать пользователя  
/unban 123456789

# Проверить статус пользователя
/status 123456789
```

## Обновленные команды администратора

1. `/give <user_id> <days>` - дать доступ на N дней
2. `/stats [active|inactive]` - статистика пользователей
3. `/wgrestart` - перезапуск WireGuard
4. `/ban <user_id>` - **НОВОЕ** - заблокировать пользователя навсегда
5. `/unban <user_id>` - **НОВОЕ** - разблокировать пользователя
6. `/status <user_id>` - **НОВОЕ** - проверить статус пользователя